<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8"><meta http-equiv="Expires" content="0"><meta http-equiv="Cache-Control" content="no-cache"><meta http-equiv="Pragma" content="no-cache"><title>Win32 SDK编程 | </title><meta name="description" content=""><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.14">
    <link rel="modulepreload" href="/assets/app.988c5f01.js"><link rel="modulepreload" href="/assets/win32.html.88df6c1a.js"><link rel="modulepreload" href="/assets/win32.html.fa46c3cf.js">
    <link rel="stylesheet" href="/assets/style.975f8c64.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class=""></path></svg></div><span><a href="/" class=""><img class="logo" src="/images/logo.png" alt><!----></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="C/C++"><span class="title">C/C++</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="C/C++"><span class="title">C/C++</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a aria-current="page" href="/c_cpp/win32.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="Win32 SDK编程"><!--[--><!--]--> Win32 SDK编程 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/c_cpp/dll-injection.html" class="nav-link" aria-label="DLL 注入相关"><!--[--><!--]--> DLL 注入相关 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/c_cpp/vc-inline-asm.html" class="nav-link" aria-label="实用技巧"><!--[--><!--]--> 实用技巧 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="NodeJS"><span class="title">NodeJS</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="NodeJS"><span class="title">NodeJS</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/nodejs/n-api.html" class="nav-link" aria-label="N-api"><!--[--><!--]--> N-api <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a href="/neural-network/" class="nav-link" aria-label="神经网络"><!--[--><!--]--> 神经网络 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/about.md" class="nav-link" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/12Tall/12tall.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="C/C++"><span class="title">C/C++</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="C/C++"><span class="title">C/C++</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a aria-current="page" href="/c_cpp/win32.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="Win32 SDK编程"><!--[--><!--]--> Win32 SDK编程 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/c_cpp/dll-injection.html" class="nav-link" aria-label="DLL 注入相关"><!--[--><!--]--> DLL 注入相关 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/c_cpp/vc-inline-asm.html" class="nav-link" aria-label="实用技巧"><!--[--><!--]--> 实用技巧 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="NodeJS"><span class="title">NodeJS</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="NodeJS"><span class="title">NodeJS</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/nodejs/n-api.html" class="nav-link" aria-label="N-api"><!--[--><!--]--> N-api <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a href="/neural-network/" class="nav-link" aria-label="神经网络"><!--[--><!--]--> 神经网络 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/about.md" class="nav-link" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/12Tall/12tall.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><section class="sidebar-group"><p class="sidebar-heading">Win32 SDK编程</p><ul class=""><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#窗口与消息机制" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="窗口与消息机制"><!--[--><!--]--> 窗口与消息机制 <!--[--><!--]--></a><ul class="sidebar-sub-headers"><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#创建win32-窗口" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="创建Win32 窗口"><!--[--><!--]--> 创建Win32 窗口 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#窗口的生命周期" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="窗口的生命周期"><!--[--><!--]--> 窗口的生命周期 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#windows-消息机制" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="Windows 消息机制"><!--[--><!--]--> Windows 消息机制 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#windows-中的安全机制" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="Windows 中的安全机制"><!--[--><!--]--> Windows 中的安全机制 <!--[--><!--]--></a><ul class="sidebar-sub-headers"><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#uac" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="UAC"><!--[--><!--]--> UAC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#uipi" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="UIPI"><!--[--><!--]--> UIPI <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#进程权限提升" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="进程权限提升"><!--[--><!--]--> 进程权限提升 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/c_cpp/win32.html#参考" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="参考"><!--[--><!--]--> 参考 <!--[--><!--]--></a><!----><!--]--></li></ul></section><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="窗口与消息机制"><a class="header-anchor" href="#窗口与消息机制">#</a> 窗口与消息机制</h2><p>首先以<a href="https://fishc.com.cn/thread-47361-1-1.html" target="_blank" rel="noopener noreferrer">鱼C论坛<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>的模板代码为例，展示一下标准的Win32 程序的基本结构。</p><h3 id="创建win32-窗口"><a class="header-anchor" href="#创建win32-窗口">#</a> 创建Win32 窗口</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string&gt;</span></span>

LRESULT CALLBACK <span class="token function">WndProc</span><span class="token punctuation">(</span>HWND<span class="token punctuation">,</span> UINT<span class="token punctuation">,</span> WPARAM<span class="token punctuation">,</span> LPARAM<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 声明函数  </span>

<span class="token comment">// [API档案] WinMain https://fishc.com.cn/thread-73544-1-1.html</span>
<span class="token keyword">int</span> WINAPI <span class="token function">WinMain</span><span class="token punctuation">(</span>
	HINSTANCE hInstance<span class="token punctuation">,</span>      <span class="token comment">// 指定应用程序当前实例的句柄</span>
							  <span class="token comment">// 因为PE 文件在内存中的首地址</span>
	                          <span class="token comment">// 所以，同一个PE 文件，在内存中的句柄是相同的</span>
	HINSTANCE hPrevInstance<span class="token punctuation">,</span>  <span class="token comment">// 此应用程序前一个实例句柄，总是为NULL</span>
							  <span class="token comment">// 检测另一个实例是否已经存在：采用CreateMutex 函数</span>
	PSTR szCmdLine<span class="token punctuation">,</span>           <span class="token comment">// 该应用程序的命令行参数</span>
	<span class="token keyword">int</span> iCmdShow              <span class="token comment">// 控制窗口显示方式</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">static</span> TCHAR szAppName<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">&quot;MyWIndows&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 定义类名  </span>
	HWND hwnd<span class="token punctuation">;</span>  <span class="token comment">// 窗口句柄  </span>
	MSG msg<span class="token punctuation">;</span>    <span class="token comment">// Windows 消息结构  </span>
	WNDCLASS wndClass<span class="token punctuation">;</span>  <span class="token comment">// 窗口类结构，用于向系统注册窗口类  </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">region 在窗口类结构中定义窗口基本属性</span></span>
	wndClass<span class="token punctuation">.</span>style <span class="token operator">=</span> CS_HREDRAW <span class="token operator">|</span> CS_VREDRAW<span class="token punctuation">;</span>  <span class="token comment">// 窗口横向、纵向变化重绘</span>
	wndClass<span class="token punctuation">.</span>lpfnWndProc <span class="token operator">=</span> WndProc<span class="token punctuation">;</span>  <span class="token comment">// 窗口消息过程函数，也是回调函数</span>
	wndClass<span class="token punctuation">.</span>cbClsExtra <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	wndClass<span class="token punctuation">.</span>cbWndExtra <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	wndClass<span class="token punctuation">.</span>hInstance <span class="token operator">=</span> hInstance<span class="token punctuation">;</span>  <span class="token comment">// 窗口所属实例</span>
	wndClass<span class="token punctuation">.</span>hIcon <span class="token operator">=</span> <span class="token function">LoadIcon</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> IDI_APPLICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
	wndClass<span class="token punctuation">.</span>hCursor <span class="token operator">=</span> <span class="token function">LoadCursor</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> IDC_ARROW<span class="token punctuation">)</span><span class="token punctuation">;</span>
	wndClass<span class="token punctuation">.</span>hbrBackground <span class="token operator">=</span> <span class="token punctuation">(</span>HBRUSH<span class="token punctuation">)</span><span class="token function">GetStockObject</span><span class="token punctuation">(</span>WHITE_BRUSH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	wndClass<span class="token punctuation">.</span>lpszMenuName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	wndClass<span class="token punctuation">.</span>lpszClassName <span class="token operator">=</span> szAppName<span class="token punctuation">;</span>  <span class="token comment">// 窗口类类名</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">endregion</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">region 向系统注册窗口类  </span></span>
	<span class="token comment">// RegisterClass https://fishc.com.cn/thread-70667-1-1.html</span>
	<span class="token comment">// 如果需要设置窗口类的小图标，则需要使用RegisterClassEx</span>
	<span class="token comment">// exe 注册的类在程序终止后会被注销；而dll 注册的则需要手动注销</span>
    <span class="token comment">// UnregisterClass https://fishc.com.cn/thread-70759-1-1.html</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">RegisterClass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wndClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">MessageBox</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>
			<span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">&quot;注册窗口类失败，这个程序需要在Windows NT 下运行！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			szAppName<span class="token punctuation">,</span>
			MB_ICONERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">endregion	</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">region 利用已经注册的窗体类创建窗体  </span></span>
	hwnd <span class="token operator">=</span> <span class="token function">CreateWindow</span><span class="token punctuation">(</span>szAppName<span class="token punctuation">,</span>  <span class="token comment">// 窗体类名</span>
		std<span class="token operator">::</span><span class="token function">to_wstring</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>hInstance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// 窗口标题</span>
		WS_OVERLAPPEDWINDOW<span class="token punctuation">,</span>        <span class="token comment">// 窗口风格</span>
		CW_USEDEFAULT<span class="token punctuation">,</span>              <span class="token comment">// x</span>
		CW_USEDEFAULT<span class="token punctuation">,</span>              <span class="token comment">// y</span>
		CW_USEDEFAULT<span class="token punctuation">,</span>              <span class="token comment">// width</span>
		CW_USEDEFAULT<span class="token punctuation">,</span>              <span class="token comment">// height</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>                       <span class="token comment">// 父窗口句柄</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>                       <span class="token comment">// 窗口菜单句柄</span>
		hInstance<span class="token punctuation">,</span>                  <span class="token comment">// 程序实例句柄</span>
		<span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// 创建参数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">endregion</span></span>

	<span class="token function">ShowWindow</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> iCmdShow<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 显示窗口  </span>
	<span class="token function">UpdateWindow</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 更新窗口</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">region 消息处理  </span></span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">GetMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">DispatchMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">endregion</span></span>

	<span class="token keyword">return</span> msg<span class="token punctuation">.</span>wParam<span class="token punctuation">;</span>  <span class="token comment">// 程序终止</span>
<span class="token punctuation">}</span>
LRESULT CALLBACK <span class="token function">WndProc</span><span class="token punctuation">(</span>HWND hwnd<span class="token punctuation">,</span> UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	HDC hdc<span class="token punctuation">;</span>
	PAINTSTRUCT ps<span class="token punctuation">;</span>
	RECT rect<span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>uMsg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">case</span> WM_PAINT<span class="token operator">:</span>
		hdc <span class="token operator">=</span> <span class="token function">BeginPaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GetClientRect</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">DrawText</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">&quot;大家好，这是我的第一个窗口程序！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rect<span class="token punctuation">,</span>
			DT_SINGLELINE <span class="token operator">|</span> DT_CENTER <span class="token operator">|</span> DT_VCENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">EndPaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">case</span> WM_DESTROY<span class="token operator">:</span>
		<span class="token function">PostQuitMessage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// call default window process</span>
	<span class="token keyword">return</span> <span class="token function">DefWindowProc</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br></div></div><h3 id="窗口的生命周期"><a class="header-anchor" href="#窗口的生命周期">#</a> 窗口的生命周期</h3><p><img src="/assets/window-lifcycle.8a86e9f8.svg" alt="生命周期"></p><h3 id="windows-消息机制"><a class="header-anchor" href="#windows-消息机制">#</a> Windows 消息机制</h3><h2 id="windows-中的安全机制"><a class="header-anchor" href="#windows-中的安全机制">#</a> Windows 中的安全机制</h2><p>在MinGW-GCC 中使用<code>OpenProcess</code> 函数不会报错，但是在Visual Studio 中却总也获取不到进程的句柄。搞了半天原来是Windows 安全机制的问题，这里简单做下笔记。</p><h3 id="uac"><a class="header-anchor" href="#uac">#</a> UAC</h3><p>UAC(User Account Control, 用户账号控制)，是从Windows Vista以来引入的新技术。目的就是严格控制进程所获得的权限。</p><ul><li>WinXP 时代： <ol><li>标准用户具有AccessToken，只能访问和修改有限的资源；</li><li>管理员组的用户具有FullAccessToken，可以获取任意资源的访问权限</li></ol></li><li>Vista 以后：即便是管理员，也尽量只以标准用户的权限启动进程 <ol><li>标准用户具有AccessToken 同XP；</li><li>以管理员登录，则会分配两个AccessToken：Standard和FullAccess。而默认情况下则以标准用户的权限创建进程。 并且需要注意的是，一个进程创建的子进程的权限一般不会更高。详情见阅：<a href="https://xiangwangfeng.com/2010/10/20/UAC%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/" target="_blank" rel="noopener noreferrer">《UAC 的前世今生》<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ol></li></ul><h3 id="uipi"><a class="header-anchor" href="#uipi">#</a> UIPI</h3><p>UIPI(User Interface Privilege Isolation, 用户界面特权隔离)。用于在程序中过滤比自己MIC(Mandatory Integrity Control, 强制完整性控制) 等级低的进程发来的消息。</p><table><thead><tr><th>MIC等级</th><th>说明</th></tr></thead><tbody><tr><td>SECURITY_MANDATORY_UNTRUSTED_RID</td><td>不信任的MIC等级</td></tr><tr><td>SECURITY_MANDATORY_LOW_RID</td><td>低MIC等级，如IE</td></tr><tr><td>SECURITY_MANDATORY_MEDIUM_RID</td><td>中MIC等级，默认为这个等级，如Explorer</td></tr><tr><td>SECURITY_MANDATORY_HIGH_RID</td><td>高MIC等级，以管理员身份运行的程序</td></tr><tr><td>SECURITY_MANDATORY_SYSTEM_RID</td><td>系统MIC等级，一般是服务应用程序</td></tr><tr><td>SECURITY_MANDATORY_PROTECTED_PROCESS_RID</td><td>被保护进程的MIC等级</td></tr></tbody></table><p>详见<a href="https://blog.csdn.net/learner198461/article/details/42223835" target="_blank" rel="noopener noreferrer">解决Win7系统下以管理员身份运行的程序接收不到拖放文件消息[WM_DROPFILES]问题的方法<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><h3 id="进程权限提升"><a class="header-anchor" href="#进程权限提升">#</a> 进程权限提升</h3><p>要实现进程的权限提升，前提条件是此进程的权限仍然有可提升的空间，即不能以标准用户运行。而权限提升的过程主要与三个Windows 系统API 相关。</p><p>以下代码引用自<a href="https://www.huaweicloud.com/articles/13251202.html" target="_blank" rel="noopener noreferrer">进程提升权限<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>，这里仅重新排版。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>BOOL <span class="token function">EnablePrivilege</span><span class="token punctuation">(</span>LPCTSTR lpszPrivilegeName<span class="token punctuation">,</span>BOOL bEnable<span class="token punctuation">)</span><span class="token punctuation">{</span> 
	HANDLE hToken<span class="token punctuation">;</span> 
	TOKEN_PRIVILEGES tp<span class="token punctuation">;</span> 
	LUID luid<span class="token punctuation">;</span> 
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OpenProcessToken</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	    TOKEN_ADJUST_PRIVILEGES <span class="token operator">|</span> TOKEN_QUERY <span class="token operator">|</span> TOKEN_READ<span class="token punctuation">,</span><span class="token operator">&amp;</span>hToken<span class="token punctuation">)</span><span class="token punctuation">)</span> 
	  <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span> 

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LookupPrivilegeValue</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> lpszPrivilegeName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>luid<span class="token punctuation">)</span><span class="token punctuation">)</span> 
	  <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>  <span class="token comment">// 这里应该return FALSE 吧</span>

	tp<span class="token punctuation">.</span>PrivilegeCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
	tp<span class="token punctuation">.</span>Privileges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Luid <span class="token operator">=</span> luid<span class="token punctuation">;</span> 
	tp<span class="token punctuation">.</span>Privileges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Attributes <span class="token operator">=</span> <span class="token punctuation">(</span>bEnable<span class="token punctuation">)</span> <span class="token operator">?</span> SE_PRIVILEGE_ENABLED <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> 
	
	<span class="token function">AdjustTokenPrivileges</span><span class="token punctuation">(</span>hToken<span class="token punctuation">,</span>FALSE<span class="token punctuation">,</span><span class="token operator">&amp;</span>tp<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hToken<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ERROR_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>下图是具体的调用流程：<br><img src="/assets/enable-privilege.3261cdab.svg" alt="权限提升过程"></p><h2 id="参考"><a class="header-anchor" href="#参考">#</a> 参考</h2><ol><li><a href="https://fishc.com.cn/forum.php?mod=forumdisplay&amp;fid=255&amp;filter=typeid&amp;typeid=420" target="_blank" rel="noopener noreferrer">WIN32-SDK-API 档案<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ol><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">7/13/2021, 12:37:23 PM</span></div><!----></footer><!----><!--[--><!--]--></main></div><!----><!--]--></div>
    <script type="module" src="/assets/app.988c5f01.js" defer></script>
  </body>
</html>
