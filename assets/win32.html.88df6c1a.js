import{r as n,o as s,c as a,a as t,F as e,b as o}from"./app.988c5f01.js";const c={},p=t("h2",{id:"窗口与消息机制"},[t("a",{class:"header-anchor",href:"#窗口与消息机制"},"#"),o(" 窗口与消息机制")],-1),l=o("首先以"),u={href:"https://fishc.com.cn/thread-47361-1-1.html",target:"_blank",rel:"noopener noreferrer"},r=o("鱼C论坛"),i=o("的模板代码为例，展示一下标准的Win32 程序的基本结构。"),k=t("h3",{id:"创建win32-窗口"},[t("a",{class:"header-anchor",href:"#创建win32-窗口"},"#"),o(" 创建Win32 窗口")],-1),b=t("div",{class:"language-c ext-c line-numbers-mode"},[t("pre",{class:"language-c"},[t("code",null,[t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"include"),t("span",{class:"token string"},"<windows.h>")]),o("\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"include"),t("span",{class:"token string"},"<string>")]),o("\n\nLRESULT CALLBACK "),t("span",{class:"token function"},"WndProc"),t("span",{class:"token punctuation"},"("),o("HWND"),t("span",{class:"token punctuation"},","),o(" UINT"),t("span",{class:"token punctuation"},","),o(" WPARAM"),t("span",{class:"token punctuation"},","),o(" LPARAM"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 声明函数  "),o("\n\n"),t("span",{class:"token comment"},"// [API档案] WinMain https://fishc.com.cn/thread-73544-1-1.html"),o("\n"),t("span",{class:"token keyword"},"int"),o(" WINAPI "),t("span",{class:"token function"},"WinMain"),t("span",{class:"token punctuation"},"("),o("\n\tHINSTANCE hInstance"),t("span",{class:"token punctuation"},","),o("      "),t("span",{class:"token comment"},"// 指定应用程序当前实例的句柄"),o("\n\t\t\t\t\t\t\t  "),t("span",{class:"token comment"},"// 因为PE 文件在内存中的首地址"),o("\n\t                          "),t("span",{class:"token comment"},"// 所以，同一个PE 文件，在内存中的句柄是相同的"),o("\n\tHINSTANCE hPrevInstance"),t("span",{class:"token punctuation"},","),o("  "),t("span",{class:"token comment"},"// 此应用程序前一个实例句柄，总是为NULL"),o("\n\t\t\t\t\t\t\t  "),t("span",{class:"token comment"},"// 检测另一个实例是否已经存在：采用CreateMutex 函数"),o("\n\tPSTR szCmdLine"),t("span",{class:"token punctuation"},","),o("           "),t("span",{class:"token comment"},"// 该应用程序的命令行参数"),o("\n\t"),t("span",{class:"token keyword"},"int"),o(" iCmdShow              "),t("span",{class:"token comment"},"// 控制窗口显示方式"),o("\n"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n\t"),t("span",{class:"token keyword"},"static"),o(" TCHAR szAppName"),t("span",{class:"token punctuation"},"["),t("span",{class:"token punctuation"},"]"),o(),t("span",{class:"token operator"},"="),o(),t("span",{class:"token function"},"TEXT"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"MyWIndows"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 定义类名  "),o("\n\tHWND hwnd"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 窗口句柄  "),o("\n\tMSG msg"),t("span",{class:"token punctuation"},";"),o("    "),t("span",{class:"token comment"},"// Windows 消息结构  "),o("\n\tWNDCLASS wndClass"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 窗口类结构，用于向系统注册窗口类  "),o("\n\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"pragma"),o(),t("span",{class:"token expression"},"region 在窗口类结构中定义窗口基本属性")]),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("style "),t("span",{class:"token operator"},"="),o(" CS_HREDRAW "),t("span",{class:"token operator"},"|"),o(" CS_VREDRAW"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 窗口横向、纵向变化重绘"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("lpfnWndProc "),t("span",{class:"token operator"},"="),o(" WndProc"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 窗口消息过程函数，也是回调函数"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("cbClsExtra "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},";"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("cbWndExtra "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},";"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("hInstance "),t("span",{class:"token operator"},"="),o(" hInstance"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 窗口所属实例"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("hIcon "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token function"},"LoadIcon"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),o(" IDI_APPLICATION"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("hCursor "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token function"},"LoadCursor"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),o(" IDC_ARROW"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("hbrBackground "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token punctuation"},"("),o("HBRUSH"),t("span",{class:"token punctuation"},")"),t("span",{class:"token function"},"GetStockObject"),t("span",{class:"token punctuation"},"("),o("WHITE_BRUSH"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("lpszMenuName "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},";"),o("\n\twndClass"),t("span",{class:"token punctuation"},"."),o("lpszClassName "),t("span",{class:"token operator"},"="),o(" szAppName"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 窗口类类名"),o("\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"pragma"),o(),t("span",{class:"token expression"},"endregion")]),o("\n\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"pragma"),o(),t("span",{class:"token expression"},"region 向系统注册窗口类  ")]),o("\n\t"),t("span",{class:"token comment"},"// RegisterClass https://fishc.com.cn/thread-70667-1-1.html"),o("\n\t"),t("span",{class:"token comment"},"// 如果需要设置窗口类的小图标，则需要使用RegisterClassEx"),o("\n\t"),t("span",{class:"token comment"},"// exe 注册的类在程序终止后会被注销；而dll 注册的则需要手动注销"),o("\n    "),t("span",{class:"token comment"},"// UnregisterClass https://fishc.com.cn/thread-70759-1-1.html"),o("\n\t"),t("span",{class:"token keyword"},"if"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),t("span",{class:"token function"},"RegisterClass"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"&"),o("wndClass"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n\t\t"),t("span",{class:"token function"},"MessageBox"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),o("\n\t\t\t"),t("span",{class:"token function"},"TEXT"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"注册窗口类失败，这个程序需要在Windows NT 下运行！"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),o("\n\t\t\tszAppName"),t("span",{class:"token punctuation"},","),o("\n\t\t\tMB_ICONERROR"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t\t"),t("span",{class:"token keyword"},"return"),o(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},";"),o("\n\t"),t("span",{class:"token punctuation"},"}"),o("\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"pragma"),o(),t("span",{class:"token expression"},"endregion\t")]),o("\n\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"pragma"),o(),t("span",{class:"token expression"},"region 利用已经注册的窗体类创建窗体  ")]),o("\n\thwnd "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token function"},"CreateWindow"),t("span",{class:"token punctuation"},"("),o("szAppName"),t("span",{class:"token punctuation"},","),o("  "),t("span",{class:"token comment"},"// 窗体类名"),o("\n\t\tstd"),t("span",{class:"token operator"},"::"),t("span",{class:"token function"},"to_wstring"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},"("),o("DWORD"),t("span",{class:"token punctuation"},")"),o("hInstance"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"."),t("span",{class:"token function"},"c_str"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),o("           "),t("span",{class:"token comment"},"// 窗口标题"),o("\n\t\tWS_OVERLAPPEDWINDOW"),t("span",{class:"token punctuation"},","),o("        "),t("span",{class:"token comment"},"// 窗口风格"),o("\n\t\tCW_USEDEFAULT"),t("span",{class:"token punctuation"},","),o("              "),t("span",{class:"token comment"},"// x"),o("\n\t\tCW_USEDEFAULT"),t("span",{class:"token punctuation"},","),o("              "),t("span",{class:"token comment"},"// y"),o("\n\t\tCW_USEDEFAULT"),t("span",{class:"token punctuation"},","),o("              "),t("span",{class:"token comment"},"// width"),o("\n\t\tCW_USEDEFAULT"),t("span",{class:"token punctuation"},","),o("              "),t("span",{class:"token comment"},"// height"),o("\n\t\t"),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),o("                       "),t("span",{class:"token comment"},"// 父窗口句柄"),o("\n\t\t"),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),o("                       "),t("span",{class:"token comment"},"// 窗口菜单句柄"),o("\n\t\thInstance"),t("span",{class:"token punctuation"},","),o("                  "),t("span",{class:"token comment"},"// 程序实例句柄"),o("\n\t\t"),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("                      "),t("span",{class:"token comment"},"// 创建参数"),o("\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"pragma"),o(),t("span",{class:"token expression"},"endregion")]),o("\n\n\t"),t("span",{class:"token function"},"ShowWindow"),t("span",{class:"token punctuation"},"("),o("hwnd"),t("span",{class:"token punctuation"},","),o(" iCmdShow"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("     "),t("span",{class:"token comment"},"// 显示窗口  "),o("\n\t"),t("span",{class:"token function"},"UpdateWindow"),t("span",{class:"token punctuation"},"("),o("hwnd"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("             "),t("span",{class:"token comment"},"// 更新窗口"),o("\n\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"pragma"),o(),t("span",{class:"token expression"},"region 消息处理  ")]),o("\n\t"),t("span",{class:"token keyword"},"while"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"GetMessage"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"&"),o("msg"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),o("\n\t"),t("span",{class:"token punctuation"},"{"),o("\n\t\t"),t("span",{class:"token function"},"TranslateMessage"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"&"),o("msg"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t\t"),t("span",{class:"token function"},"DispatchMessage"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"&"),o("msg"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t"),t("span",{class:"token punctuation"},"}"),o("\n"),t("span",{class:"token macro property"},[t("span",{class:"token directive-hash"},"#"),t("span",{class:"token directive keyword"},"pragma"),o(),t("span",{class:"token expression"},"endregion")]),o("\n\n\t"),t("span",{class:"token keyword"},"return"),o(" msg"),t("span",{class:"token punctuation"},"."),o("wParam"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 程序终止"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\nLRESULT CALLBACK "),t("span",{class:"token function"},"WndProc"),t("span",{class:"token punctuation"},"("),o("HWND hwnd"),t("span",{class:"token punctuation"},","),o(" UINT uMsg"),t("span",{class:"token punctuation"},","),o(" WPARAM wParam"),t("span",{class:"token punctuation"},","),o(" LPARAM lParam"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token punctuation"},"{"),o("\n\tHDC hdc"),t("span",{class:"token punctuation"},";"),o("\n\tPAINTSTRUCT ps"),t("span",{class:"token punctuation"},";"),o("\n\tRECT rect"),t("span",{class:"token punctuation"},";"),o("\n\n\t"),t("span",{class:"token keyword"},"switch"),o(),t("span",{class:"token punctuation"},"("),o("uMsg"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"{"),o("\n\t"),t("span",{class:"token keyword"},"case"),o(" WM_PAINT"),t("span",{class:"token operator"},":"),o("\n\t\thdc "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token function"},"BeginPaint"),t("span",{class:"token punctuation"},"("),o("hwnd"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token operator"},"&"),o("ps"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t\t"),t("span",{class:"token function"},"GetClientRect"),t("span",{class:"token punctuation"},"("),o("hwnd"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token operator"},"&"),o("rect"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t\t"),t("span",{class:"token function"},"DrawText"),t("span",{class:"token punctuation"},"("),o("hdc"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token function"},"TEXT"),t("span",{class:"token punctuation"},"("),t("span",{class:"token string"},'"大家好，这是我的第一个窗口程序！"'),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token operator"},"-"),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token operator"},"&"),o("rect"),t("span",{class:"token punctuation"},","),o("\n\t\t\tDT_SINGLELINE "),t("span",{class:"token operator"},"|"),o(" DT_CENTER "),t("span",{class:"token operator"},"|"),o(" DT_VCENTER"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t\t"),t("span",{class:"token function"},"EndPaint"),t("span",{class:"token punctuation"},"("),o("hwnd"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token operator"},"&"),o("ps"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t\t"),t("span",{class:"token keyword"},"return"),o(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},";"),o("\n\n\t"),t("span",{class:"token keyword"},"case"),o(" WM_DESTROY"),t("span",{class:"token operator"},":"),o("\n\t\t"),t("span",{class:"token function"},"PostQuitMessage"),t("span",{class:"token punctuation"},"("),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t\t"),t("span",{class:"token keyword"},"return"),o(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},";"),o("\n\t"),t("span",{class:"token punctuation"},"}"),o("\n\n\t"),t("span",{class:"token comment"},"// call default window process"),o("\n\t"),t("span",{class:"token keyword"},"return"),o(),t("span",{class:"token function"},"DefWindowProc"),t("span",{class:"token punctuation"},"("),o("hwnd"),t("span",{class:"token punctuation"},","),o(" uMsg"),t("span",{class:"token punctuation"},","),o(" wParam"),t("span",{class:"token punctuation"},","),o(" lParam"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br"),t("span",{class:"line-number"},"22"),t("br"),t("span",{class:"line-number"},"23"),t("br"),t("span",{class:"line-number"},"24"),t("br"),t("span",{class:"line-number"},"25"),t("br"),t("span",{class:"line-number"},"26"),t("br"),t("span",{class:"line-number"},"27"),t("br"),t("span",{class:"line-number"},"28"),t("br"),t("span",{class:"line-number"},"29"),t("br"),t("span",{class:"line-number"},"30"),t("br"),t("span",{class:"line-number"},"31"),t("br"),t("span",{class:"line-number"},"32"),t("br"),t("span",{class:"line-number"},"33"),t("br"),t("span",{class:"line-number"},"34"),t("br"),t("span",{class:"line-number"},"35"),t("br"),t("span",{class:"line-number"},"36"),t("br"),t("span",{class:"line-number"},"37"),t("br"),t("span",{class:"line-number"},"38"),t("br"),t("span",{class:"line-number"},"39"),t("br"),t("span",{class:"line-number"},"40"),t("br"),t("span",{class:"line-number"},"41"),t("br"),t("span",{class:"line-number"},"42"),t("br"),t("span",{class:"line-number"},"43"),t("br"),t("span",{class:"line-number"},"44"),t("br"),t("span",{class:"line-number"},"45"),t("br"),t("span",{class:"line-number"},"46"),t("br"),t("span",{class:"line-number"},"47"),t("br"),t("span",{class:"line-number"},"48"),t("br"),t("span",{class:"line-number"},"49"),t("br"),t("span",{class:"line-number"},"50"),t("br"),t("span",{class:"line-number"},"51"),t("br"),t("span",{class:"line-number"},"52"),t("br"),t("span",{class:"line-number"},"53"),t("br"),t("span",{class:"line-number"},"54"),t("br"),t("span",{class:"line-number"},"55"),t("br"),t("span",{class:"line-number"},"56"),t("br"),t("span",{class:"line-number"},"57"),t("br"),t("span",{class:"line-number"},"58"),t("br"),t("span",{class:"line-number"},"59"),t("br"),t("span",{class:"line-number"},"60"),t("br"),t("span",{class:"line-number"},"61"),t("br"),t("span",{class:"line-number"},"62"),t("br"),t("span",{class:"line-number"},"63"),t("br"),t("span",{class:"line-number"},"64"),t("br"),t("span",{class:"line-number"},"65"),t("br"),t("span",{class:"line-number"},"66"),t("br"),t("span",{class:"line-number"},"67"),t("br"),t("span",{class:"line-number"},"68"),t("br"),t("span",{class:"line-number"},"69"),t("br"),t("span",{class:"line-number"},"70"),t("br"),t("span",{class:"line-number"},"71"),t("br"),t("span",{class:"line-number"},"72"),t("br"),t("span",{class:"line-number"},"73"),t("br"),t("span",{class:"line-number"},"74"),t("br"),t("span",{class:"line-number"},"75"),t("br"),t("span",{class:"line-number"},"76"),t("br"),t("span",{class:"line-number"},"77"),t("br"),t("span",{class:"line-number"},"78"),t("br"),t("span",{class:"line-number"},"79"),t("br"),t("span",{class:"line-number"},"80"),t("br"),t("span",{class:"line-number"},"81"),t("br"),t("span",{class:"line-number"},"82"),t("br"),t("span",{class:"line-number"},"83"),t("br"),t("span",{class:"line-number"},"84"),t("br"),t("span",{class:"line-number"},"85"),t("br"),t("span",{class:"line-number"},"86"),t("br"),t("span",{class:"line-number"},"87"),t("br"),t("span",{class:"line-number"},"88"),t("br"),t("span",{class:"line-number"},"89"),t("br"),t("span",{class:"line-number"},"90"),t("br"),t("span",{class:"line-number"},"91"),t("br"),t("span",{class:"line-number"},"92"),t("br"),t("span",{class:"line-number"},"93"),t("br"),t("span",{class:"line-number"},"94"),t("br"),t("span",{class:"line-number"},"95"),t("br"),t("span",{class:"line-number"},"96"),t("br")])],-1),m=t("h3",{id:"窗口的生命周期"},[t("a",{class:"header-anchor",href:"#窗口的生命周期"},"#"),o(" 窗口的生命周期")],-1),d=t("p",null,[t("img",{src:"/assets/window-lifcycle.8a86e9f8.svg",alt:"生命周期"})],-1),h=t("h3",{id:"windows-消息机制"},[t("a",{class:"header-anchor",href:"#windows-消息机制"},"#"),o(" Windows 消息机制")],-1),w=t("h2",{id:"windows-中的安全机制"},[t("a",{class:"header-anchor",href:"#windows-中的安全机制"},"#"),o(" Windows 中的安全机制")],-1),E=t("p",null,[o("在MinGW-GCC 中使用"),t("code",null,"OpenProcess"),o(" 函数不会报错，但是在Visual Studio 中却总也获取不到进程的句柄。搞了半天原来是Windows 安全机制的问题，这里简单做下笔记。")],-1),C=t("h3",{id:"uac"},[t("a",{class:"header-anchor",href:"#uac"},"#"),o(" UAC")],-1),g=t("p",null,"UAC(User Account Control, 用户账号控制)，是从Windows Vista以来引入的新技术。目的就是严格控制进程所获得的权限。",-1),f=t("li",null,[o("WinXP 时代： "),t("ol",null,[t("li",null,"标准用户具有AccessToken，只能访问和修改有限的资源；"),t("li",null,"管理员组的用户具有FullAccessToken，可以获取任意资源的访问权限")])],-1),A=o("Vista 以后：即便是管理员，也尽量只以标准用户的权限启动进程 "),I=t("li",null,"标准用户具有AccessToken 同XP；",-1),T=o("以管理员登录，则会分配两个AccessToken：Standard和FullAccess。而默认情况下则以标准用户的权限创建进程。 并且需要注意的是，一个进程创建的子进程的权限一般不会更高。详情见阅："),L={href:"https://xiangwangfeng.com/2010/10/20/UAC%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/",target:"_blank",rel:"noopener noreferrer"},R=o("《UAC 的前世今生》"),N=t("h3",{id:"uipi"},[t("a",{class:"header-anchor",href:"#uipi"},"#"),o(" UIPI")],-1),P=t("p",null,"UIPI(User Interface Privilege Isolation, 用户界面特权隔离)。用于在程序中过滤比自己MIC(Mandatory Integrity Control, 强制完整性控制) 等级低的进程发来的消息。",-1),U=t("table",null,[t("thead",null,[t("tr",null,[t("th",null,"MIC等级"),t("th",null,"说明")])]),t("tbody",null,[t("tr",null,[t("td",null,"SECURITY_MANDATORY_UNTRUSTED_RID"),t("td",null,"不信任的MIC等级")]),t("tr",null,[t("td",null,"SECURITY_MANDATORY_LOW_RID"),t("td",null,"低MIC等级，如IE")]),t("tr",null,[t("td",null,"SECURITY_MANDATORY_MEDIUM_RID"),t("td",null,"中MIC等级，默认为这个等级，如Explorer")]),t("tr",null,[t("td",null,"SECURITY_MANDATORY_HIGH_RID"),t("td",null,"高MIC等级，以管理员身份运行的程序")]),t("tr",null,[t("td",null,"SECURITY_MANDATORY_SYSTEM_RID"),t("td",null,"系统MIC等级，一般是服务应用程序")]),t("tr",null,[t("td",null,"SECURITY_MANDATORY_PROTECTED_PROCESS_RID"),t("td",null,"被保护进程的MIC等级")])])],-1),_=o("详见"),S={href:"https://blog.csdn.net/learner198461/article/details/42223835",target:"_blank",rel:"noopener noreferrer"},y=o("解决Win7系统下以管理员身份运行的程序接收不到拖放文件消息[WM_DROPFILES]问题的方法"),W=t("h3",{id:"进程权限提升"},[t("a",{class:"header-anchor",href:"#进程权限提升"},"#"),o(" 进程权限提升")],-1),D=t("p",null,"要实现进程的权限提升，前提条件是此进程的权限仍然有可提升的空间，即不能以标准用户运行。而权限提升的过程主要与三个Windows 系统API 相关。",-1),M=o("以下代码引用自"),v={href:"https://www.huaweicloud.com/articles/13251202.html",target:"_blank",rel:"noopener noreferrer"},O=o("进程提升权限"),x=o("，这里仅重新排版。"),H=t("div",{class:"language-c ext-c line-numbers-mode"},[t("pre",{class:"language-c"},[t("code",null,[o("BOOL "),t("span",{class:"token function"},"EnablePrivilege"),t("span",{class:"token punctuation"},"("),o("LPCTSTR lpszPrivilegeName"),t("span",{class:"token punctuation"},","),o("BOOL bEnable"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},"{"),o(" \n\tHANDLE hToken"),t("span",{class:"token punctuation"},";"),o(" \n\tTOKEN_PRIVILEGES tp"),t("span",{class:"token punctuation"},";"),o(" \n\tLUID luid"),t("span",{class:"token punctuation"},";"),o(" \n\t\n\t"),t("span",{class:"token keyword"},"if"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),t("span",{class:"token function"},"OpenProcessToken"),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"GetCurrentProcess"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},","),o("\n\t    TOKEN_ADJUST_PRIVILEGES "),t("span",{class:"token operator"},"|"),o(" TOKEN_QUERY "),t("span",{class:"token operator"},"|"),o(" TOKEN_READ"),t("span",{class:"token punctuation"},","),t("span",{class:"token operator"},"&"),o("hToken"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),o(" \n\t  "),t("span",{class:"token keyword"},"return"),o(" FALSE"),t("span",{class:"token punctuation"},";"),o(" \n\n\t"),t("span",{class:"token keyword"},"if"),t("span",{class:"token punctuation"},"("),t("span",{class:"token operator"},"!"),t("span",{class:"token function"},"LookupPrivilegeValue"),t("span",{class:"token punctuation"},"("),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),o(" lpszPrivilegeName"),t("span",{class:"token punctuation"},","),o(),t("span",{class:"token operator"},"&"),o("luid"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},")"),o(" \n\t  "),t("span",{class:"token keyword"},"return"),o(" TRUE"),t("span",{class:"token punctuation"},";"),o("  "),t("span",{class:"token comment"},"// 这里应该return FALSE 吧"),o("\n\n\ttp"),t("span",{class:"token punctuation"},"."),o("PrivilegeCount "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token number"},"1"),t("span",{class:"token punctuation"},";"),o(" \n\ttp"),t("span",{class:"token punctuation"},"."),o("Privileges"),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"."),o("Luid "),t("span",{class:"token operator"},"="),o(" luid"),t("span",{class:"token punctuation"},";"),o(" \n\ttp"),t("span",{class:"token punctuation"},"."),o("Privileges"),t("span",{class:"token punctuation"},"["),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},"]"),t("span",{class:"token punctuation"},"."),o("Attributes "),t("span",{class:"token operator"},"="),o(),t("span",{class:"token punctuation"},"("),o("bEnable"),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"?"),o(" SE_PRIVILEGE_ENABLED "),t("span",{class:"token operator"},":"),o(),t("span",{class:"token number"},"0"),t("span",{class:"token punctuation"},";"),o(" \n\t\n\t"),t("span",{class:"token function"},"AdjustTokenPrivileges"),t("span",{class:"token punctuation"},"("),o("hToken"),t("span",{class:"token punctuation"},","),o("FALSE"),t("span",{class:"token punctuation"},","),t("span",{class:"token operator"},"&"),o("tp"),t("span",{class:"token punctuation"},","),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},","),t("span",{class:"token constant"},"NULL"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n\t\n\t"),t("span",{class:"token function"},"CloseHandle"),t("span",{class:"token punctuation"},"("),o("hToken"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o(" \n\t"),t("span",{class:"token keyword"},"return"),o(),t("span",{class:"token punctuation"},"("),t("span",{class:"token function"},"GetLastError"),t("span",{class:"token punctuation"},"("),t("span",{class:"token punctuation"},")"),o(),t("span",{class:"token operator"},"=="),o(" ERROR_SUCCESS"),t("span",{class:"token punctuation"},")"),t("span",{class:"token punctuation"},";"),o("\n"),t("span",{class:"token punctuation"},"}"),o("\n")])]),t("div",{class:"line-numbers"},[t("span",{class:"line-number"},"1"),t("br"),t("span",{class:"line-number"},"2"),t("br"),t("span",{class:"line-number"},"3"),t("br"),t("span",{class:"line-number"},"4"),t("br"),t("span",{class:"line-number"},"5"),t("br"),t("span",{class:"line-number"},"6"),t("br"),t("span",{class:"line-number"},"7"),t("br"),t("span",{class:"line-number"},"8"),t("br"),t("span",{class:"line-number"},"9"),t("br"),t("span",{class:"line-number"},"10"),t("br"),t("span",{class:"line-number"},"11"),t("br"),t("span",{class:"line-number"},"12"),t("br"),t("span",{class:"line-number"},"13"),t("br"),t("span",{class:"line-number"},"14"),t("br"),t("span",{class:"line-number"},"15"),t("br"),t("span",{class:"line-number"},"16"),t("br"),t("span",{class:"line-number"},"17"),t("br"),t("span",{class:"line-number"},"18"),t("br"),t("span",{class:"line-number"},"19"),t("br"),t("span",{class:"line-number"},"20"),t("br"),t("span",{class:"line-number"},"21"),t("br")])],-1),Y=t("p",null,[o("下图是具体的调用流程："),t("br"),t("img",{src:"/assets/enable-privilege.3261cdab.svg",alt:"权限提升过程"})],-1),B=t("h2",{id:"参考"},[t("a",{class:"header-anchor",href:"#参考"},"#"),o(" 参考")],-1),G={href:"https://fishc.com.cn/forum.php?mod=forumdisplay&fid=255&filter=typeid&typeid=420",target:"_blank",rel:"noopener noreferrer"},F=o("WIN32-SDK-API 档案");c.render=function(o,c){const V=n("OutboundLink");return s(),a(e,null,[p,t("p",null,[l,t("a",u,[r,t(V)]),i]),k,b,m,d,h,w,E,C,g,t("ul",null,[f,t("li",null,[A,t("ol",null,[I,t("li",null,[T,t("a",L,[R,t(V)])])])])]),N,P,U,t("p",null,[_,t("a",S,[y,t(V)])]),W,D,t("p",null,[M,t("a",v,[O,t(V)]),x]),H,Y,B,t("ol",null,[t("li",null,[t("a",G,[F,t(V)])])])],64)};export default c;
